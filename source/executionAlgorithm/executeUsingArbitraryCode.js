"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.executeUsingArbitraryCode = executeUsingArbitraryCode;var _util = _interopRequireDefault(require("util"));
var _vm = _interopRequireDefault(require("vm"));





function executeUsingArbitraryCode({
  scriptPath,
  jsCodeToEvaluate,
  parameter = {},
  adapterFunction = null })
{
  let scriptModule = require(scriptPath);
  scriptModule = createModuleProxy({ target: scriptModule, adapterFunction, additionalParameter: parameter });

  let contextEnvironment = _vm.default.createContext(Object.assign({

    _requiredModule_: scriptModule,

    parameter: parameter },

  typeof parameter == 'object' ? parameter : {}));

  let vmScript = new _vm.default.Script(`
            _requiredModule_${jsCodeToEvaluate}
        `, {
    filename: scriptPath });

  try {
    vmScript.runInContext(contextEnvironment, {
      breakOnSigint: true });

  } catch (error) {
    console.log(`âŒ 'vm.runInContext' ${scriptPath} running in its own context failed.`);
    console.log(`scriptModule/_requiredModule_ (i.e. required script path) is equal to : ${_util.default.inspect(scriptModule, { colors: true, compact: false })}`);
    throw error;
  }
}

function createModuleProxy({
  target,

  additionalParameter,
  adapterFunction })
{
  if (typeof target != 'function' && typeof target != 'object') return target;
  return new Proxy(target, {
    apply: function (_target, thisArg, argumentsList) {
      if (typeof additionalParameter == 'object' && typeof argumentsList[0] == 'object')
        argumentsList[0] = Object.assign(additionalParameter, argumentsList[0]);
      if (adapterFunction)
        return adapterFunction({ callback: _target, args: argumentsList })();else

      return _target(...argumentsList);
    },
    get: (_target, property, receiver) => {
      let propertyValue = Reflect.get(_target, property, receiver);
      return createModuleProxy({ target: propertyValue, adapterFunction, additionalParameter });
    } });

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS9leGVjdXRpb25BbGdvcml0aG0vZXhlY3V0ZVVzaW5nQXJiaXRyYXJ5Q29kZS5qcyJdLCJuYW1lcyI6WyJleGVjdXRlVXNpbmdBcmJpdHJhcnlDb2RlIiwic2NyaXB0UGF0aCIsImpzQ29kZVRvRXZhbHVhdGUiLCJwYXJhbWV0ZXIiLCJhZGFwdGVyRnVuY3Rpb24iLCJzY3JpcHRNb2R1bGUiLCJyZXF1aXJlIiwiY3JlYXRlTW9kdWxlUHJveHkiLCJ0YXJnZXQiLCJhZGRpdGlvbmFsUGFyYW1ldGVyIiwiY29udGV4dEVudmlyb25tZW50Iiwidm0iLCJjcmVhdGVDb250ZXh0IiwiT2JqZWN0IiwiYXNzaWduIiwiX3JlcXVpcmVkTW9kdWxlXyIsInZtU2NyaXB0IiwiU2NyaXB0IiwiZmlsZW5hbWUiLCJydW5JbkNvbnRleHQiLCJicmVha09uU2lnaW50IiwiZXJyb3IiLCJjb25zb2xlIiwibG9nIiwidXRpbCIsImluc3BlY3QiLCJjb2xvcnMiLCJjb21wYWN0IiwiUHJveHkiLCJhcHBseSIsIl90YXJnZXQiLCJ0aGlzQXJnIiwiYXJndW1lbnRzTGlzdCIsImNhbGxiYWNrIiwiYXJncyIsImdldCIsInByb3BlcnR5IiwicmVjZWl2ZXIiLCJwcm9wZXJ0eVZhbHVlIiwiUmVmbGVjdCJdLCJtYXBwaW5ncyI6IjhOQUFBO0FBQ0E7Ozs7OztBQU1PLFNBQVNBLHlCQUFULENBQW1DO0FBQ3RDQyxFQUFBQSxVQURzQztBQUV0Q0MsRUFBQUEsZ0JBRnNDO0FBR3RDQyxFQUFBQSxTQUFTLEdBQUcsRUFIMEI7QUFJdENDLEVBQUFBLGVBQWUsR0FBRyxJQUpvQixFQUFuQztBQUtKO0FBQ0MsTUFBSUMsWUFBWSxHQUFHQyxPQUFPLENBQUNMLFVBQUQsQ0FBMUI7QUFDQUksRUFBQUEsWUFBWSxHQUFHRSxpQkFBaUIsQ0FBQyxFQUFFQyxNQUFNLEVBQUVILFlBQVYsRUFBd0JELGVBQXhCLEVBQXlDSyxtQkFBbUIsRUFBRU4sU0FBOUQsRUFBRCxDQUFoQzs7QUFFQSxNQUFJTyxrQkFBa0IsR0FBR0MsWUFBR0MsYUFBSCxDQUFpQkMsTUFBTSxDQUFDQyxNQUFQLENBQWM7O0FBRWhEQyxJQUFBQSxnQkFBZ0IsRUFBRVYsWUFGOEI7O0FBSWhERixJQUFBQSxTQUFTLEVBQUVBLFNBSnFDLEVBQWQ7O0FBTXJDLFNBQU9BLFNBQVAsSUFBb0IsUUFBckIsR0FBaUNBLFNBQWpDLEdBQTZDLEVBTlAsQ0FBakIsQ0FBekI7O0FBUUEsTUFBSWEsUUFBUSxHQUFHLElBQUlMLFlBQUdNLE1BQVAsQ0FBZTs4QkFDSmYsZ0JBQWlCO1NBRDVCLEVBRVI7QUFDSGdCLElBQUFBLFFBQVEsRUFBRWpCLFVBRFAsRUFGUSxDQUFmOztBQUtBLE1BQUk7QUFDQWUsSUFBQUEsUUFBUSxDQUFDRyxZQUFULENBQXNCVCxrQkFBdEIsRUFBMEM7QUFDdENVLE1BQUFBLGFBQWEsRUFBRSxJQUR1QixFQUExQzs7QUFHSCxHQUpELENBSUUsT0FBT0MsS0FBUCxFQUFjO0FBQ1pDLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLHVCQUFzQnRCLFVBQVcscUNBQTlDO0FBQ0FxQixJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSwyRUFBMEVDLGNBQUtDLE9BQUwsQ0FBYXBCLFlBQWIsRUFBMkIsRUFBRXFCLE1BQU0sRUFBRSxJQUFWLEVBQWdCQyxPQUFPLEVBQUUsS0FBekIsRUFBM0IsQ0FBNkQsRUFBcEo7QUFDQSxVQUFNTixLQUFOO0FBQ0g7QUFDSjs7QUFFRCxTQUFTZCxpQkFBVCxDQUEyQjtBQUN2QkMsRUFBQUEsTUFEdUI7O0FBR3ZCQyxFQUFBQSxtQkFIdUI7QUFJdkJMLEVBQUFBLGVBSnVCLEVBQTNCO0FBS0c7QUFDQyxNQUFHLE9BQU9JLE1BQVAsSUFBaUIsVUFBakIsSUFBK0IsT0FBT0EsTUFBUCxJQUFpQixRQUFuRCxFQUE2RCxPQUFPQSxNQUFQO0FBQzdELFNBQU8sSUFBSW9CLEtBQUosQ0FBVXBCLE1BQVYsRUFBa0I7QUFDckJxQixJQUFBQSxLQUFLLEVBQUUsVUFBU0MsT0FBVCxFQUFrQkMsT0FBbEIsRUFBMkJDLGFBQTNCLEVBQTBDO0FBQzdDLFVBQUcsT0FBT3ZCLG1CQUFQLElBQThCLFFBQTlCLElBQTBDLE9BQU91QixhQUFhLENBQUMsQ0FBRCxDQUFwQixJQUEyQixRQUF4RTtBQUNJQSxRQUFBQSxhQUFhLENBQUMsQ0FBRCxDQUFiLEdBQW1CbkIsTUFBTSxDQUFDQyxNQUFQLENBQWNMLG1CQUFkLEVBQW1DdUIsYUFBYSxDQUFDLENBQUQsQ0FBaEQsQ0FBbkI7QUFDSixVQUFHNUIsZUFBSDtBQUNJLGVBQU9BLGVBQWUsQ0FBQyxFQUFFNkIsUUFBUSxFQUFFSCxPQUFaLEVBQXFCSSxJQUFJLEVBQUVGLGFBQTNCLEVBQUQsQ0FBZixFQUFQLENBREo7O0FBR0ksYUFBT0YsT0FBTyxDQUFDLEdBQUdFLGFBQUosQ0FBZDtBQUNQLEtBUm9CO0FBU3JCRyxJQUFBQSxHQUFHLEVBQUUsQ0FBQ0wsT0FBRCxFQUFVTSxRQUFWLEVBQW9CQyxRQUFwQixLQUFpQztBQUNsQyxVQUFJQyxhQUFhLEdBQUdDLE9BQU8sQ0FBQ0osR0FBUixDQUFZTCxPQUFaLEVBQXFCTSxRQUFyQixFQUErQkMsUUFBL0IsQ0FBcEI7QUFDQSxhQUFPOUIsaUJBQWlCLENBQUMsRUFBRUMsTUFBTSxFQUFFOEIsYUFBVixFQUF5QmxDLGVBQXpCLEVBQTBDSyxtQkFBMUMsRUFBRCxDQUF4QjtBQUNILEtBWm9CLEVBQWxCLENBQVA7O0FBY0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXRpbCBmcm9tICd1dGlsJ1xuaW1wb3J0IHZtIGZyb20gJ3ZtJ1xuXG4vKiogXG4gKiBFeGVjdXRlIGBzY3JpcHRDb2ZuaWcudHlwZSA9PSAnanNDb2RlVG9FdmFsdWF0ZSdgIHdoZXJlIHRoZSBzY3JpcHQgaXMgcmVxdWlyZWQgYW5kIHRoZSBqc0NvZGVUb0V2YWx1YXRlIGlzIGV2YWx1YXRlZCBvbiB0aGUgcmVxdWlyZWQgZmlsZS5cbiAqIHRoaXMgaXMgYSBkaWZmZXJlbnQgYXBwcm9hY2ggd2hlcmUgY29tbWFuZCBhcmd1bWVudHMgYXJlbid0IG5lZWRlZCBhcyB0aGUgcGFyYW1ldGVycyBhcmUgcGFzc2VkIGFzIEpTIGNvZGUgYW5kIGV2YWx1YXRlZC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGVVc2luZ0FyYml0cmFyeUNvZGUoeyBcbiAgICBzY3JpcHRQYXRoLCBcbiAgICBqc0NvZGVUb0V2YWx1YXRlLCBcbiAgICBwYXJhbWV0ZXIgPSB7fSxcbiAgICBhZGFwdGVyRnVuY3Rpb24gPSBudWxsIC8vIHRoZSBhZGFwdGVyIG11c3QgcmV0dXJuIGEgZnVuY3Rpb24gd2hlcmUgaXQgZW5jYXBzdWxhdGVzIHRoZSBzcGVjaWZpYyBuZWVkZWQgaW1wbGVtZW50YXRpb24gZm9yIHRoZSBzY3JpcHQuXG59KSB7XG4gICAgbGV0IHNjcmlwdE1vZHVsZSA9IHJlcXVpcmUoc2NyaXB0UGF0aClcbiAgICBzY3JpcHRNb2R1bGUgPSBjcmVhdGVNb2R1bGVQcm94eSh7IHRhcmdldDogc2NyaXB0TW9kdWxlLCBhZGFwdGVyRnVuY3Rpb24sIGFkZGl0aW9uYWxQYXJhbWV0ZXI6IHBhcmFtZXRlciB9KVxuICAgIFxuICAgIGxldCBjb250ZXh0RW52aXJvbm1lbnQgPSB2bS5jcmVhdGVDb250ZXh0KE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgLy8gcHJveHkgZm9yIGNhbGxpbmcgZmlyc3QgZnVuY3Rpb24gaW4gdGhlIHRyZWUsIHBhc3MgYXJndW1lbnRzLiBcbiAgICAgICAgICAgIF9yZXF1aXJlZE1vZHVsZV86IHNjcmlwdE1vZHVsZSwgLy8gcGFzcyByZXF1aXJlZCBzY3JpcHRcbiAgICAgICAgICAgIC8vIHJlcXVpcmUgLy8gcGFzcyBnbG9iYWwgcmVxdWlyZSB0byB0aGUgZXZhbHVhdGVkIGNvZGUgY29udGV4dCxcbiAgICAgICAgICAgIHBhcmFtZXRlcjogcGFyYW1ldGVyXG4gICAgICAgIH0sXG4gICAgICAgICh0eXBlb2YgcGFyYW1ldGVyID09ICdvYmplY3QnKSA/IHBhcmFtZXRlciA6IHt9IC8vIG1ha2UgYWxsIGtleXMgYXZhaWxhYmxlIGZvciB0aGUgc2NyaXB0IGFzIGdsb2JhbHNcbiAgICApKVxuICAgIGxldCB2bVNjcmlwdCA9IG5ldyB2bS5TY3JpcHQoYFxuICAgICAgICAgICAgX3JlcXVpcmVkTW9kdWxlXyR7anNDb2RlVG9FdmFsdWF0ZX1cbiAgICAgICAgYCwgeyAvLyB3aGVyZSBgcmVxdWlyZWRNb2R1bGVgIGlzIHRoZSByZXF1aXJlZCBzY3JpcHQgdmFyaWFibGUgZnJvbSB0aGUgY29udGV4dFxuICAgICAgICBmaWxlbmFtZTogc2NyaXB0UGF0aCAvLyBhZGQgZmlsZSB0byBOb2RlJ3MgZXZlbnQgbG9vcCBzdGFjayB0cmFjZVxuICAgIH0pXG4gICAgdHJ5IHtcbiAgICAgICAgdm1TY3JpcHQucnVuSW5Db250ZXh0KGNvbnRleHRFbnZpcm9ubWVudCwge1xuICAgICAgICAgICAgYnJlYWtPblNpZ2ludDogdHJ1ZSAvLyBicmVhayB3aGVuIEN0cmwrQyBpcyByZWNlaXZlZC5cbiAgICAgICAgfSkgIFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDinYwgJ3ZtLnJ1bkluQ29udGV4dCcgJHtzY3JpcHRQYXRofSBydW5uaW5nIGluIGl0cyBvd24gY29udGV4dCBmYWlsZWQuYClcbiAgICAgICAgY29uc29sZS5sb2coYHNjcmlwdE1vZHVsZS9fcmVxdWlyZWRNb2R1bGVfIChpLmUuIHJlcXVpcmVkIHNjcmlwdCBwYXRoKSBpcyBlcXVhbCB0byA6ICR7dXRpbC5pbnNwZWN0KHNjcmlwdE1vZHVsZSwgeyBjb2xvcnM6IHRydWUsIGNvbXBhY3Q6IGZhbHNlIH0pfWApXG4gICAgICAgIHRocm93IGVycm9yXG4gICAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVNb2R1bGVQcm94eSh7XG4gICAgdGFyZ2V0LCAvLyB0YXJnZXQgbW9kdWxlIG9yIHN1YnByb3BlcnRpZXMgb2YgbW9kdWxlIChyZWN1cnNpdmUgY2FsbHMpXG4gICAgLy8gbWVyZ2luZyBzdXBwb3J0cyBvbmx5IHdoZW4gdGhlIGFkZGl0aW9uYWwgcGFyYW1ldGVyIGlzIGFuIG9iamVjdCBhbmQgZmlyc3QgYXJndW1lbnQgb2YgdGhlIGpzIGNvZGUgaXMgYW4gb2JqZWN0IHRvby4gSW4gb3RoZXIgY2Fzc2VzIHRoZSBhZGRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSBpZ25vcmVkIGluIGNhbGxpbmcuXG4gICAgYWRkaXRpb25hbFBhcmFtZXRlciwgLy8gcGFyYW1ldGVycyB0byBhZGQgdG8gdGhlIGFyZ3VtZW50cyBjYWxsICh3aGVyZSBhcmd1bWVudHMgY2FsbCBhcmUgZnJvbSB0aGUgZXZhbHVhdGVkIGpzIGNvZGUgYW5kIHBhcmFtZXRlciBhcmUgZnJvbSB0aGUgYXBpIGNhbGxlciBlLmcuIHNjcmlwdE1hbmFnZXIpXG4gICAgYWRhcHRlckZ1bmN0aW9uXG59KSB7IC8vIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHJlY3Vyc2l2ZWx5IHRvIHN1cHBvcnQgbmVzdGVkIG9iamVjdHMgaW4gY2FzZSB0aGUgdGFyZ2V0IGlzIGFuIG9iamVjdC5cbiAgICBpZih0eXBlb2YgdGFyZ2V0ICE9ICdmdW5jdGlvbicgJiYgdHlwZW9mIHRhcmdldCAhPSAnb2JqZWN0JykgcmV0dXJuIHRhcmdldCAvLyBpZ25vcmUgbm9uLW9iamVjdHMgYW5kIG5vbi1mdW5jdGlvbnMuXG4gICAgcmV0dXJuIG5ldyBQcm94eSh0YXJnZXQsIHsgLy8gY3JlYXRlIGEgcHJveHkgdG8gYXBwbHkgYGFkYXB0ZXJGdW5jdGlvbmAgb24gdGhlIGZpcnN0IGNhbGxlZCBmdW5jdGlvbi5cbiAgICAgICAgYXBwbHk6IGZ1bmN0aW9uKF90YXJnZXQsIHRoaXNBcmcsIGFyZ3VtZW50c0xpc3QpIHtcbiAgICAgICAgICAgIGlmKHR5cGVvZiBhZGRpdGlvbmFsUGFyYW1ldGVyID09ICdvYmplY3QnICYmIHR5cGVvZiBhcmd1bWVudHNMaXN0WzBdID09ICdvYmplY3QnKSAvLyBzdXBwb3J0cyBvbmx5IG9iamVjdHNcbiAgICAgICAgICAgICAgICBhcmd1bWVudHNMaXN0WzBdID0gT2JqZWN0LmFzc2lnbihhZGRpdGlvbmFsUGFyYW1ldGVyLCBhcmd1bWVudHNMaXN0WzBdKVxuICAgICAgICAgICAgaWYoYWRhcHRlckZ1bmN0aW9uKSAvLyBhcHBseSB0aGUgYWRhcHRlciBvbiB0aGUgZmlyc3QgY2FsbGVkIGZ1bmN0aW9uIGUuZy4gYDxzY3JpcHRNb2R1bGU+LngueS56KDxhcHBseSBhZGFwdGVyPilgIG9yIGA8c2NyaXB0TW9kdWxlPig8YXBwbHkgYWRhcHRlcj4pYFxuICAgICAgICAgICAgICAgIHJldHVybiBhZGFwdGVyRnVuY3Rpb24oeyBjYWxsYmFjazogX3RhcmdldCwgYXJnczogYXJndW1lbnRzTGlzdH0pKClcbiAgICAgICAgICAgIGVsc2UgXG4gICAgICAgICAgICAgICAgcmV0dXJuIF90YXJnZXQoLi4uYXJndW1lbnRzTGlzdClcbiAgICAgICAgfSwgXG4gICAgICAgIGdldDogKF90YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikgPT4ge1xuICAgICAgICAgICAgbGV0IHByb3BlcnR5VmFsdWUgPSBSZWZsZWN0LmdldChfdGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpXG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlTW9kdWxlUHJveHkoeyB0YXJnZXQ6IHByb3BlcnR5VmFsdWUsIGFkYXB0ZXJGdW5jdGlvbiwgYWRkaXRpb25hbFBhcmFtZXRlciB9KVxuICAgICAgICB9XG4gICAgfSlcbn1cblxuIl19